// utils/filters.js
import { normalizeText } from './normalize.js';

// תוכן שנסיר ערכית (נשאיר את המפתח קיים עם ערך ריק)
export const COLUMNS_TO_HIDE_CONTENT = [
  'רזומה פרטים מלאים של המועמד/ת',
  'רזומה של המועמד בלי טל\' ומייל'
];

// שדות-ליבה שנשמרים תמיד כדי שהמסננים יעבדו
export const CORE_FILTER_FIELDS_RAW = [
  'עדה',
  'זכר/נקבה', 'מידע- זכר/נקבה ', 'מגדר',
  'מצב אישי', 'מצב שלך',
  'גיל', 'גיל ידני',
  'גובה',
  'כיסוי ראש/ הזקן',
  'למועמדת הציפיות ממראה הזקן של הבן זוג/ למועמד הציפיות לכיסוי ראש של הבת זוג',
  'כשרות טלפון',
  'הרצון ללמוד יום שלם',
  'מס\' קבוצה בארגון',
  'שם', 'שם מלא', 'שם פרטי',
  'תמונה', 'טלפון', 'כתובת מייל', 'ת"ז'
];

// שדות מיוחדים ששומרים גולמי (נשתמש ברינדור קומפקטי בצד לקוח)
export const SPECIAL_KEEP_RAW = ['הצעות מהתוכנה'];

// שדות שלא נציג בכרטיס (נסיר מהתצוגה; נשמור CORE/SPECIAL)
export const EXCLUDED_FIELDS_RAW = [
  'רזומה', '__EMPTY_20', '__EMPTY_22', '__EMPTY_3', '__EMPTY_2',
  'חותמת זמן', 'R', 'M',
  'השדכן אישר קבלת המייל',
  'תאריך לועזי',
  'דיווח של השדכן על ההצעה הנוכחית',
  'שם השדכן המטפל כעת במועמד',
  'רזומה מלא של המועמד/ת', 'ההצעות שהיו במחזור הנוכחי', 'בתמציתיות מצב השידוך', 'מועמד לא מזוהה',
  'הצעות חדשות  למועמד/ת ',
  'הקוד של המועמד/ת במידה ורשומים כבר בארגון, ורוצים הצעות חדשות או לעדכן נתונים במאגר ',
  'שדכן אחר שאינו שייך לארגון אהבת עולם', 'שדכן אחר שאינו שייך לארגון "אהבת עולם"',
  'הצעות שלא באות בחשבון כלל',
  'נעשה משלוח לשדכנים ע"י התוכנה',
  'משלוח הודעה למועמד/ת ראשון הבא בחשבון לפגישה כגון בקשת תמונה או פרטים אחרים',
  'הקוד של המועמד/ת השני הבא בחשבון לפגישה במידה ואין תגובה מהמועמד/ת הראשון',
  'משלוח הודעה למועמד/ת השני הבא בחשבון לפגישה כגון בקשת תמונה או פרטים אחרים',
  'נעשה משלוח הודעה לצד השני',
  '41. הערות של המועמד/ת על ההצעות שקיבל/ה',
  'לעדכן נתונים או לשלוח את בחירתכם ל"הצעות הבאות בחשבון"',
  'לעדכן נתונים או לשלוח את בחירתכם להצעות הבאות בחשבון ולהצעות שלא באות בחשבון שקיבלתם?',
  'האם הצעות לפרק ב?', 'האם הצעות לפרק ב\'?',
  'מידע לשדכנים או עבור מועמדים',
  'מידע- קוד השדכן ',
  'מידע- מצב המועמד/ת', 'מידע- זכר/נקבה ', 'מידע-תחום גילאים', 'מידע- עדה',
  'מידע- תחום הגובה', 'מידע- כיסוי ראש ', 'מידע- מראה הזקן לבחורים', 'מידע- טלפון -כשר',
  'מידע- הרצון ללמוד יום שלם/ חלקי', 'מידע- כתובת מגורים', 'מידע- מספר הצעות המבוקש',
  'מידע- האם רוצים רשימה או רזומה של המועמדים',
  'פירוט עדה', '__EMPTY_1',
  'זכר/נקבה',
  'הצעות אחרונות', 'הצעות לפני אחרונות',
  'דיווח על אירוסין/הסרה',
  'הקוד הראשון של הבאים בחשבון',
  // את "הצעות מהתוכנה" נרנדר קומפקטית בצד לקוח, לכן לא מציגים גולמי
  'הצעות מהתוכנה',
  'הקוד של המועמד/ת, שאליו רוצים לשלוח הודעה', 'נשלח ע"י התוכנה ההודעה לצד השני', 'ההודעה שצריך לשלוח',
  'הקוד הראשון של "הבאים בחשבון"', 'הודעה למועמד/ת ראשון הבא בחשבון לפגישה כגון בקשת תמונה או פרטים אחרים',
  'הקוד של מועמד/ת השני הבא בחשבון לפגישה במידה ואין תגובה מהמועמד/ת הראשון', 'הודעה למועמד/ת השני הבא בחשבון לפגישה כגון בקשת תמונה או פרטים אחרים',
  'הקוד הראשון של "הבאים בחשבון"_1',
  'לעדכן נתונים או לשלוח את בחירתכם ל"הצעות הבאות בחשבון"',
  'מידע לשדכנים או עבור מועמדים'
];

// האם לשמור שדה למרות שהוא ב-EXCLUDED
function shouldPreserveKeyForFilters(key) {
  const k = normalizeText(key);
  const inCore = CORE_FILTER_FIELDS_RAW.some(n => normalizeText(n) === k);
  const inSpecial = SPECIAL_KEEP_RAW.some(n => normalizeText(n) === k);
  return inCore || inSpecial;
}

// מאפס ערכים לשדות שמסתירים תוכן
function hideContentValues(row) {
  const out = { ...row };
  for (const k of Object.keys(out)) {
    const mk = normalizeText(k);
    if (COLUMNS_TO_HIDE_CONTENT.some(n => normalizeText(n) === mk)) {
      out[k] = '';
    }
  }
  return out;
}

// הסרה לתצוגה: מסיר מפתחות שנמצאים ב-EXCLUDED, אלא אם צריך לשמרם
export function stripExcludedKeysPreservingCore(row) {
  const cleaned = hideContentValues(row);
  const out = {};
  for (const [k, v] of Object.entries(cleaned)) {
    const mk = normalizeText(k);
    const isExcluded = EXCLUDED_FIELDS_RAW.some(n => normalizeText(n) === mk);
    if (isExcluded && !shouldPreserveKeyForFilters(k)) continue;
    out[k] = v;
  }
  return out;
}
